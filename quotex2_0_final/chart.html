<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <title>Cortex 2.0 – Custom AI Candle Engine</title>
    <script src="https://unpkg.com/lightweight-charts@4.1.1/dist/lightweight-charts.standalone.production.js"></script>
    <style>
        html,
        body {
            margin: 0;
            padding: 0;
            height: 100%;
            background: #0a0e12;
            overflow: hidden;
        }

        #chart {
            width: 100%;
            height: 100%;
        }
    </style>
</head>

<body>
    <div id="chart"></div>

    <script>
/* --------------------------------------------------------------
   1️⃣  Firebase init (same config you already use in admin‑core.js)
   -------------------------------------------------------------- */
const firebaseConfig = {
    apiKey: "AIzaSyBx4i‑LJcCuYNWfYU_TfXA6_LXcY263RbA",
    authDomain: "jay-shree-shyam0back.firebaseapp.com",
    projectId: "jay-shree-shyam0back",
    storageBucket: "jay-shree-shyam0back.firebasestorage.app",
    messagingSenderId: "1084861244978",
    appId: "1:1084861244978:web:192eb36bf370ffa60a3e2b",
    measurementId: "G‑WZVE9YYDGB"
};
if (!firebase.apps.length) firebase.initializeApp(firebaseConfig);
const db = firebase.database();

/* --------------------------------------------------------------
   2️⃣  Chart setup
   -------------------------------------------------------------- */
const container = document.getElementById('chart');
const chart = LightweightCharts.createChart(container, {
    layout: { background: { type: 'solid', color: '#000000' }, textColor: '#d1d4dc' },
    grid: { vertLines: { color: '#1a1e29' }, horzLines: { color: '#1a1e29' } },
    rightPriceScale: { borderColor: '#2a2e39' },
    timeScale: { borderColor: '#2a2e39', timeVisible: true }
});
const candleSeries = chart.addCandlestickSeries({
    upColor: '#00ff41',
    downColor: '#ff003c',
    borderVisible: false,
    wickUpColor: '#00ff41',
    wickDownColor: '#ff003c'
});

/* --------------------------------------------------------------
   3️⃣  Custom candle generation (your supplied logic)
   -------------------------------------------------------------- */
let currentPrice = 42150;
let time = Math.floor(Date.now() / 1000) - 10000;   // start ~10 000 s ago
const data = [];
function generateCandle(){
    const open  = currentPrice;
    const close = open + (Math.random() - 0.48) * 40;   // volatility bias
    const high  = Math.max(open, close) + Math.random() * 10;
    const low   = Math.min(open, close) - Math.random() * 10;
    currentPrice = close;
    time += 60; // one‑minute resolution
    return {time, open, high, low, close};
}

/* --------------------------------------------------------------
   4️⃣  Load the first 150 candles (clean canvas – no old data)
   -------------------------------------------------------------- */
for(let i=0;i<150;i++) data.push(generateCandle());
candleSeries.setData(data);

/* --------------------------------------------------------------
   5️⃣  Admin‑signal handling – overrides the *next* candle
   -------------------------------------------------------------- */
let pendingSignal = null; // 'UP' | 'DOWN' | null
db.ref('control/signal').on('value', snap => {
    const val = snap.val();
    if(val === 'UP' || val === 'DOWN') pendingSignal = val; else pendingSignal = null;
});

/* --------------------------------------------------------------
   6️⃣  Real‑time update loop (300 ms) – applies override if present
   -------------------------------------------------------------- */
setInterval(() => {
    const last = data[data.length-1];
    // normal random delta
    let delta = (Math.random() - 0.46) * 12;
    let close = last.close + delta;
    // admin override (force one candle only)
    if(pendingSignal === 'UP'){
        close = Math.max(last.open, close) + Math.abs(delta) + 5;
    } else if(pendingSignal === 'DOWN'){
        close = Math.min(last.open, close) - Math.abs(delta) - 5;
    }
    pendingSignal = null; // consume the signal
    // update last candle
    last.close = close;
    last.high = Math.max(last.high, close);
    last.low = Math.min(last.low, close);
    candleSeries.update(last);
    // occasionally push a brand‑new candle
    if(Math.random() > 0.95){
        const newCandle = generateCandle();
        data.push(newCandle);
        candleSeries.update(newCandle);
    }
}, 300);

/* --------------------------------------------------------------
   7️⃣  Responsive resize
   -------------------------------------------------------------- */
window.addEventListener('resize', () => {
    chart.applyOptions({width: container.clientWidth, height: container.clientHeight});
});
    </script>
</body>

</html>